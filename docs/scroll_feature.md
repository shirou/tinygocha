# スクロール機能仕様書

## 概要

TinyGochaの大規模戦場（5000px × 5000px）に対応するスクロール機能の仕様書です。
プレイヤーが戦場全体を自由に移動・観察できるカメラシステムを実装します。

## 基本仕様

### 戦場とビューポート
- **戦場サイズ**: 5000px × 5000px（500m × 500m）
- **ビューポートサイズ**: 1024px × 768px（約102m × 77m）
- **表示可能範囲**: 戦場全体の約20% × 15%

### カメラ座標系
- **原点**: 戦場左上角 (0, 0)
- **カメラ位置**: ビューポート左上角の戦場座標
- **初期位置**: (2000, 2000) - 戦場中央付近
- **移動範囲**: X: 0 ～ 3976, Y: 0 ～ 4232

## スクロール方式

### 1. マウススクロール（エッジスクロール）
プレイヤーがマウスカーソルを画面端に移動することでスクロール

#### 設定値（高速化版）
- **境界幅**: 50px（画面端から50px以内でスクロール開始）
- **スクロール速度**: 400px/s（基本速度、4倍高速化）
- **加速度**: 3.0（境界に近づくほど高速、1.5倍高速化）
- **最大速度**: 1600px/s（400 × (1 + 3.0) = 1600px/s）

#### 動作仕様
```
スクロール速度 = 基本速度 × (1 + 加速度 × 境界侵入率)
境界侵入率 = (50 - 境界からの距離) / 50
```

### 2. キーボードスクロール
WASDキーまたは矢印キーによる直接スクロール

#### キー割り当て
- **W / ↑**: 上スクロール
- **A / ←**: 左スクロール
- **S / ↓**: 下スクロール
- **D / →**: 右スクロール

#### 設定値（高速化版）
- **スクロール速度**: 500px/s（マウスより高速、3.3倍高速化）
- **加速時間**: 0.5秒（徐々に最大速度に到達）
- **減速時間**: 0.3秒（キーを離した時の減速）

### 3. ドラッグスクロール（中ボタン）
マウス中ボタンドラッグによる自由スクロール

#### 動作仕様（高速化版）
- **開始**: 中ボタン押下
- **移動**: ドラッグ方向と逆方向にカメラ移動
- **感度**: 2:1（マウス移動量の2倍でカメラ移動、高感度化）
- **慣性**: なし（即座に停止）

## ズーム機能

### ズームレベル
| レベル | 倍率 | 表示範囲 | 1px当たり | 用途 |
|--------|------|----------|-----------|------|
| 0.25x | 25% | 408m×308m | 40cm | 全体俯瞰 |
| 0.5x | 50% | 204m×154m | 20cm | 戦術俯瞰 |
| 1.0x | 100% | 102m×77m | 10cm | 通常戦闘 |
| 1.5x | 150% | 68m×51m | 6.7cm | 詳細戦闘 |
| 2.0x | 200% | 51m×38m | 5cm | 最大拡大 |

### ズーム操作
- **マウスホイール**: 上回転で拡大、下回転で縮小
- **キーボード**: + / - キー
- **ズーム中心**: マウスカーソル位置
- **ズーム速度**: 0.25刻み、0.2秒でアニメーション

### ズーム時のスクロール調整（高速化版）
```
実際のスクロール速度 = 基本速度 / ズーム倍率

例：
- ズーム1.0x: 500px/s（キーボード）、400px/s（エッジ）
- ズーム0.5x: 1000px/s（キーボード）、800px/s（エッジ）
- ズーム2.0x: 250px/s（キーボード）、200px/s（エッジ）
```

## ミニマップ機能

### 基本仕様
- **サイズ**: 200px × 200px
- **位置**: 画面右上 (824, 10)
- **スケール**: 1/25（戦場5000px → ミニマップ200px）
- **更新頻度**: 30FPS（メイン画面の半分）

### 表示要素
- **地形**: 簡略化された地形色
- **ユニット**: 色付きドット（敵味方区別）
- **ビューポート**: 白い矩形枠
- **重要オブジェクト**: 建物、拠点など

### ミニマップ操作
- **左クリック**: 該当位置にカメラ移動
- **ドラッグ**: ビューポート矩形をドラッグしてカメラ移動
- **右クリック**: ミニマップの表示/非表示切り替え

## パフォーマンス最適化

### カリング（描画範囲制限）
- **基本範囲**: ビューポート範囲のみ描画
- **マージン**: +100px（画面外オブジェクトの一部描画）
- **ユニット**: 画面外は位置更新のみ、描画スキップ
- **エフェクト**: 画面外は完全スキップ

### LOD（詳細度制御）
| ズームレベル | ユニット描画 | エフェクト | UI要素 |
|-------------|-------------|-----------|--------|
| 0.25x | 簡略ドット | なし | 最小限 |
| 0.5x | 簡略スプライト | 簡略 | 基本 |
| 1.0x | 通常スプライト | 通常 | 全表示 |
| 1.5x+ | 詳細スプライト | 詳細 | 全表示 |

### メモリ管理
- **テクスチャ**: 必要な範囲のみロード
- **ユニットデータ**: 全体をメモリ保持
- **地形データ**: チャンク分割（512px × 512px）
- **エフェクト**: プール管理で再利用

## UI統合

### スクロール状態表示
- **座標表示**: 現在のカメラ位置（デバッグ時）
- **ズーム表示**: 現在のズーム倍率
- **ミニマップ**: 常時表示（設定で非表示可能）

### 操作ヘルプ
- **F1キー**: ヘルプ表示
- **表示内容**: スクロール操作方法、ショートカット一覧

### 設定項目
- **スクロール速度**: 50% ～ 200%
- **エッジスクロール**: 有効/無効
- **ズーム感度**: 50% ～ 200%
- **ミニマップ**: 表示/非表示
- **座標表示**: 有効/無効（デバッグ用）

## 実装クラス構成

### CameraManager
カメラの位置・ズーム管理

```go
type CameraManager struct {
    X, Y          float64  // カメラ位置
    Zoom          float64  // ズーム倍率
    TargetX, TargetY float64  // 目標位置（スムーズ移動用）
    TargetZoom    float64  // 目標ズーム
    
    // 制約
    MinX, MinY    float64  // 最小位置
    MaxX, MaxY    float64  // 最大位置
    MinZoom, MaxZoom float64  // ズーム範囲
    
    // 設定
    ScrollSpeed   float64  // スクロール速度
    ZoomSpeed     float64  // ズーム速度
    SmoothMove    bool     // スムーズ移動有効
}
```

### ScrollController
スクロール入力の処理

```go
type ScrollController struct {
    camera        *CameraManager
    edgeScrolling bool     // エッジスクロール有効
    keyScrolling  bool     // キーボードスクロール有効
    dragScrolling bool     // ドラッグスクロール有効
    
    // 状態
    isDragging    bool     // ドラッグ中
    dragStartX, dragStartY int  // ドラッグ開始位置
    
    // 設定
    edgeWidth     int      // エッジ幅
    scrollSpeed   float64  // スクロール速度
}
```

### Minimap
ミニマップの描画・操作

```go
type Minimap struct {
    camera     *CameraManager
    battlefield *Battlefield
    
    // 表示設定
    X, Y       int     // ミニマップ位置
    Width, Height int  // ミニマップサイズ
    Scale      float64 // スケール比
    Visible    bool    // 表示状態
    
    // 描画用
    mapImage   *ebiten.Image  // ミニマップ画像
    needUpdate bool           // 更新フラグ
}
```

## 座標変換関数

### スクリーン座標 ↔ ワールド座標
```go
// スクリーン座標をワールド座標に変換
func ScreenToWorld(screenX, screenY int, camera *CameraManager) (float64, float64) {
    worldX := camera.X + float64(screenX)/camera.Zoom
    worldY := camera.Y + float64(screenY)/camera.Zoom
    return worldX, worldY
}

// ワールド座標をスクリーン座標に変換
func WorldToScreen(worldX, worldY float64, camera *CameraManager) (int, int) {
    screenX := int((worldX - camera.X) * camera.Zoom)
    screenY := int((worldY - camera.Y) * camera.Zoom)
    return screenX, screenY
}
```

### ミニマップ座標変換
```go
// ワールド座標をミニマップ座標に変換
func WorldToMinimap(worldX, worldY float64, minimap *Minimap) (int, int) {
    minimapX := int(worldX * minimap.Scale) + minimap.X
    minimapY := int(worldY * minimap.Scale) + minimap.Y
    return minimapX, minimapY
}

// ミニマップ座標をワールド座標に変換
func MinimapToWorld(minimapX, minimapY int, minimap *Minimap) (float64, float64) {
    worldX := float64(minimapX - minimap.X) / minimap.Scale
    worldY := float64(minimapY - minimap.Y) / minimap.Scale
    return worldX, worldY
}
```

## テスト仕様

### 単体テスト
- **CameraManager**: 位置制約、ズーム制約のテスト
- **ScrollController**: 各種入力に対する応答テスト
- **座標変換**: 変換精度のテスト

### 統合テスト
- **スクロール動作**: 各種スクロール方式の動作確認
- **ズーム動作**: ズーム時の表示・操作確認
- **ミニマップ**: ミニマップ操作の確認

### パフォーマンステスト
- **描画負荷**: 大量ユニット時の描画性能
- **メモリ使用量**: 長時間プレイ時のメモリリーク確認
- **CPU使用率**: スクロール・ズーム時のCPU負荷

## 今後の拡張予定

### 高度な機能
- **自動追従**: 選択ユニットの自動追従
- **ブックマーク**: 重要地点の記録・ジャンプ
- **リプレイ**: 戦闘の録画・再生時のカメラ制御

### UI改善
- **スムーズズーム**: より滑らかなズームアニメーション
- **慣性スクロール**: スクロール停止時の慣性効果
- **ジェスチャー**: タッチデバイス対応

### パフォーマンス向上
- **オクルージョンカリング**: 遮蔽物による描画最適化
- **動的LOD**: 距離・重要度による詳細度自動調整
- **並列処理**: マルチスレッドによる描画最適化
